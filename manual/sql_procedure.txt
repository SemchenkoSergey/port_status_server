CREATE DEFINER=`admin`@`localhost` PROCEDURE `stat_account`(IN `account` varchar(50)) SELECT ao.account_name 'Учетное имя', ao.hostname 'Hostname', ao.board 'Board', ao.port 'Port', MIN(dd.max_dw_rate) 'Мин. вх. скор.', MAX(dd.max_dw_rate) 'Макс. вх. скор.', ROUND(AVG(dd.max_dw_rate)) 'Сред. вх. скор.', CAST(dd.datetime AS DATE) 'Дата' FROM abon_onyma ao INNER JOIN data_dsl dd ON ao.hostname=dd.hostname AND ao.board=dd.board AND ao.port=dd.port WHERE ao.account_name = account GROUP BY CAST(dd.datetime AS DATE) ORDER BY dd.datetime;

CREATE DEFINER=`admin`@`localhost` PROCEDURE `stat_account_day`(IN `account` varchar(50), IN `day_count` tinyint) SELECT ao.account_name 'Учетное имя', dd.hostname 'Hostname', dd.board 'Board', dd.port 'Port', dd.max_up_rate 'Макс. исх. скор.', dd.max_dw_rate 'Макс. вх. скор.', dd.up_rate 'Исх. скор.', dd.dw_rate 'Вх. скор.', dd.up_att 'Исх. затух.', dd.dw_att 'Вх. затух.', dd.up_snr 'Исх. SNR', dd.dw_snr 'Вх. SNR', dd.datetime 'Дата/Время' FROM abon_onyma ao INNER JOIN data_dsl dd ON ao.hostname=dd.hostname AND ao.board=dd.board AND ao.port=dd.port WHERE CAST(dd.datetime AS DATE) > DATE_ADD(CURRENT_DATE(), INTERVAL -day_count DAY) AND ao.account_name = account ORDER BY dd.datetime;

CREATE DEFINER=`admin`@`localhost` PROCEDURE `stat_phone`(IN `phone` varchar(10)) SELECT ao.phone_number 'Номер тел.', ao.hostname 'Hostname', ao.board 'Board', ao.port 'Port', MIN(dd.max_dw_rate) 'Мин. вх. скор.', MAX(dd.max_dw_rate) 'Макс. вх. скор.', ROUND(AVG(dd.max_dw_rate)) 'Сред. вх. скор.', CAST(dd.datetime AS DATE) 'Дата' FROM abon_onyma ao INNER JOIN data_dsl dd ON ao.hostname=dd.hostname AND ao.board=dd.board AND ao.port=dd.port WHERE ao.phone_number = phone GROUP BY CAST(dd.datetime AS DATE) ORDER BY dd.datetime;

CREATE DEFINER=`admin`@`localhost` PROCEDURE `stat_phone_day`(IN `phone` char(10), IN `day_count` tinyint) SELECT ao.phone_number 'Номер тел.', dd.hostname 'Hostname', dd.board 'Board', dd.port 'Port', dd.max_up_rate 'Макс. исх. скор.', dd.max_dw_rate 'Макс. вх. скор.', dd.up_rate 'Исх. скор.', dd.dw_rate 'Вх. скор.', dd.up_att 'Исх. затух.', dd.dw_att 'Вх. затух.', dd.up_snr 'Исх. SNR', dd.dw_snr 'Вх. SNR', dd.datetime 'Дата/Время' FROM abon_onyma ao INNER JOIN data_dsl dd ON ao.hostname=dd.hostname AND ao.board=dd.board AND ao.port=dd.port WHERE CAST(dd.datetime AS DATE) > DATE_ADD(CURRENT_DATE(), INTERVAL -day_count DAY) AND ao.phone_number = phone ORDER BY dd.datetime;

CREATE DEFINER=`admin`@`localhost` PROCEDURE `stat_port`(IN `in_hostname` char(50), IN `in_board` tinyint, IN `in_port` tinyint) SELECT hostname 'Hostname', board 'Board', port 'Port', MIN(max_dw_rate) 'Мин. вх. скор.', MAX(max_dw_rate) 'Макс. вх. скор.', ROUND(AVG(max_dw_rate)) 'Сред. вх. скор.', CAST(datetime AS DATE) 'Дата' FROM data_dsl WHERE hostname = in_hostname AND board=in_board AND port=in_port GROUP BY CAST(datetime AS DATE) ORDER BY datetime;

CREATE DEFINER=`admin`@`localhost` PROCEDURE `stat_port_day`(IN `in_hostname` varchar(50), IN `in_board` tinyint, IN `in_port` tinyint, IN `day_count` tinyint) SELECT hostname 'Hostname', board 'Board', port 'Port', max_up_rate 'Макс. исх. скор.', max_dw_rate 'Макс. вх. скор.', up_rate 'Исх. скор.', dw_rate 'Вх. скор.', up_att 'Исх. затух.', dw_att 'Вх. затух.', up_snr 'Исх. SNR', dw_snr 'Вх. SNR', datetime 'Дата/Время' FROM data_dsl WHERE CAST(datetime AS DATE) > DATE_ADD(CURRENT_DATE(), INTERVAL -day_count DAY) AND hostname = in_hostname AND board = in_board AND port = in_port ORDER BY datetime;

CREATE DEFINER=`admin`@`localhost` PROCEDURE `stat_street`(IN `locality` char(50), IN `street` char(50), IN `day_count` tinyint) SELECT aa.locality 'Нас. пункт', aa.street 'Улица', aa.house_number 'Дом', aa.apartment_number '№ кв.', aa.phone_number 'Номер тел.', ROUND(AVG(dd.max_up_rate)) 'Ср. исх. скор.', ROUND(AVG(dd.max_dw_rate)) 'Ср. вх. скор.', ao.tariff_name 'Тарифф' FROM ( SELECT * FROM data_dsl WHERE CAST(datetime AS DATE) > DATE_ADD(CURRENT_DATE(), INTERVAL -day_count DAY) ) dd INNER JOIN abon_onyma ao ON dd.hostname=ao.hostname AND dd.board=ao.board AND dd.port=ao.port INNER JOIN abon_argus aa ON ao.phone_number=aa.phone_number WHERE aa.locality LIKE CONCAT('%', locality, '%') AND aa.street LIKE CONCAT('%', street, '%') GROUP BY aa.phone_number HAVING AVG(dd.max_up_rate) IS NOT NULL AND AVG(dd.max_dw_rate) IS NOT NULL ORDER BY CAST(aa.house_number AS SIGNED), aa.apartment_number;
