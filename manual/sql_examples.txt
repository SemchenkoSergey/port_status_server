--- Выборка для IPTV (7 дней) --- 
(вместо Светлоград указывается населенный пункт)

SELECT
 phone_number 'Номер тел.',
 ad.locality 'Нас. пункт',
 ad.street 'Улица',
 ad.house_number 'Дом',
 ad.apartment_number '№ кв.',
 MIN(dd.max_dw_rate) 'Мин. вх. скор.',
 MAX(dd.max_dw_rate) 'Макс. вх. скор.',
 dd.hostname 'Hostname',
 dd.board 'Board',
 dd.port 'Port' 
FROM abon_dsl ad INNER JOIN data_dsl dd
 ON ad.hostname=dd.hostname
 AND ad.board=dd.board
 AND ad.port=dd.port
WHERE
 dd.datetime >= DATE_ADD(CURRENT_DATE(), INTERVAL -7 DAY)
 AND dd.max_dw_rate IS NOT NULL
 AND ad.valid = 'yes'  
 AND ad.tv = 'no'
 AND ad.locality LIKE '%Светлоград%'
GROUP BY ad.phone_number
HAVING MIN(dd.max_dw_rate) > 15000
ORDER BY ad.street, CAST(ad.house_number AS SIGNED);


--- Статистика улицы с прошлого дня ---
(вместо Светлоград указывается населенный пункт, вместо Уральская указывается улица)

SELECT
 ad.locality 'Нас. пункт',
 ad.street 'Улица',
 ad.house_number 'Дом',
 ad.apartment_number '№ кв.',
 ad.phone_number 'Номер тел.',
 ROUND(AVG(dd.max_up_rate)) 'Ср. исх. скор.',
 ROUND(AVG(dd.max_dw_rate)) 'Ср. вх. скор.'
FROM abon_dsl ad INNER JOIN data_dsl dd
 ON ad.hostname=dd.hostname
 AND ad.board=dd.board
 AND ad.port=dd.port
WHERE
 dd.datetime >= DATE_ADD(CURRENT_DATE(), INTERVAL -1 DAY)
 AND ad.valid = 'yes' 
 AND ad.locality LIKE '%Светлоград%'
 AND ad.street LIKE '%Уральская%'
GROUP BY ad.phone_number
HAVING
 AVG(dd.max_up_rate) IS NOT NULL
 AND AVG(dd.max_dw_rate) IS NOT NULL
ORDER BY CAST(ad.house_number AS SIGNED), ad.apartment_number;


--- Статистика абонента по дням (мин., макс., сред. скорость) ---
(вместо 8654740169 указывается номер телефона)

SELECT
 ad.phone_number 'Номер тел.',
 dd.hostname 'Hostname',
 dd.board 'Board',
 dd.port 'Port',
 MIN(dd.max_dw_rate) 'Мин. вх. скор.',
 MAX(dd.max_dw_rate) 'Макс. вх. скор.',
 ROUND(AVG(dd.max_dw_rate)) 'Сред. вх. скор.',
 CAST(dd.datetime AS DATE) 'Дата'
FROM abon_dsl ad INNER JOIN data_dsl dd
 ON ad.hostname=dd.hostname
 AND ad.board=dd.board
 AND ad.port=dd.port
WHERE
 ad.valid = 'yes'
 AND ad.phone_number = '8654740169'
GROUP BY CAST(dd.datetime AS DATE)
ORDER BY dd.datetime;


--- Статистика порта по дням (мин., макс., сред. скорость) ---
(вместо 'STV-SVET-ATS4-DSL3-H5600' указывается hostname, board - плата, port - номер порта)
SELECT
 hostname 'Hostname',
 board 'Board',
 port 'Port',
 MIN(max_dw_rate) 'Мин. вх. скор.',
 MAX(max_dw_rate) 'Макс. вх. скор.',
 ROUND(AVG(max_dw_rate)) 'Сред. вх. скор.',
 CAST(datetime AS DATE) 'Дата'
FROM data_dsl
WHERE
 hostname = 'STV-SVET-ATS4-DSL3-H5600'
 AND board=1
 AND port=49
GROUP BY CAST(datetime AS DATE)
ORDER BY datetime;


--- Статистика абонента за последние 3 дня по часам ---
(вместо 8654740169 указывается номер телефона)

SELECT
 ad.phone_number 'Номер тел.',
 dd.hostname 'Hostname',
 dd.board 'Board',
 dd.port 'Port',
 dd.max_up_rate 'Макс. исх. скор.',
 dd.max_dw_rate 'Макс. вх. скор.',
 dd.up_rate 'Исх. скор.',
 dd.dw_rate 'Вх. скор.',
 dd.datetime 'Дата/Время'
FROM abon_dsl ad INNER JOIN data_dsl dd
 ON ad.hostname=dd.hostname
 AND ad.board=dd.board
 AND ad.port=dd.port
WHERE
 dd.datetime >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)
 AND ad.valid = 'yes'
 AND ad.phone_number = '8654745615'
ORDER BY dd.datetime;


--- Статистика порта за последние 3 дня по часам ---
(вместо 'STV-SVET-ATS4-DSL3-H5600' указывается hostname, board - плата, port - номер порта)

SELECT
 hostname 'Hostname',
 board 'Board',
 port 'Port',
 max_up_rate 'Макс. исх. скор.',
 max_dw_rate 'Макс. вх. скор.',
 up_rate 'Исх. скор.',
 dw_rate 'Вх. скор.',
 datetime 'Дата/Время'
FROM data_dsl
WHERE
 datetime >= DATE_ADD(CURRENT_DATE(), INTERVAL -3 DAY)
 AND hostname = 'STV-SVET-ATS4-DSL3-H5600'
 AND board=1
 AND port=49
ORDER BY datetime;




--- Для коммерческого блока ---

SELECT
 ao.servis_point 'Пункт продаж',
 ao.phone_number 'Номер тел.',
 ao.contract 'Номер договора',
 ao.account_name 'Учетное имя',
 ao.address 'Адрес',
 ao.name 'Ф.И.О.',
 ao.tariff 'Тариф',
 ao.tv 'Наличие ТВ',
 dd.min_rate 'Мин. расч. вх. скор.',
 dd.avg_rate 'Ср. расч. вх. скор.',
 dd.max_rate 'Макс. расч. вх. скор.',
 dp.profile_name 'Название профиля DSLAM',
 dp.up_limit 'Ограничение Upstream',
 dp.dw_limit 'Ограничение Downstream',
 ao.hostname 'Hostname',
 ao.board 'Board',
 ao.port 'Port' 
FROM (
 SELECT
  hostname,
  board,
  port,
  MIN(max_dw_rate) min_rate,
  MAX(max_dw_rate) max_rate,
  ROUND(AVG(max_dw_rate)) avg_rate
 FROM
  data_dsl
 WHERE
  datetime BETWEEN STR_TO_DATE('2018-10-17 00:00:00', '%Y-%m-%d %H:%i:%s')
  AND STR_TO_DATE('2018-10-18 23:59:59', '%Y-%m-%d %H:%i:%s')
 GROUP BY hostname, board, port
 ) dd INNER JOIN abon_onyma ao 
 ON dd.hostname=ao.hostname
 AND dd.board=ao.board
 AND dd.port=ao.port
 INNER JOIN data_profiles dp
  ON ao.hostname=dp.hostname
  AND ao.board=dp.board
  AND ao.port=dp.port
WHERE 
 dd.max_rate IS NOT NULL
GROUP BY ao.account_name
ORDER BY ao.servis_point, ao.hostname, ao.board, ao.port
INTO OUTFILE '/var/lib/mysql-files/Krai.csv' FIELDS TERMINATED BY ';' ;
